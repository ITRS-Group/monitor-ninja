Name: monitor-ninja
Version: @@VERSION@@
Release: @@RELEASE@@
License: op5 Software License
Packager: build@op5
Vendor: op5 AB
BuildRoot: /tmp/%name-%version
Summary: op5 monitor ninja
Group: op5/Monitor
Prefix: /opt/monitor
Requires: monitor-gui-core
Requires: merlin, monitor-reports-module >= 2.0.6
Source: %name-%version.tar.gz
%description
Webgui for Nagios 3.

%prep
%setup -q

%build
pushd cli-helpers
make
popd

%install
mkdir -p -m 755 %buildroot%prefix/op5/ninja
cp -r * %buildroot%prefix/op5/ninja
sed -i 's/\([\t ]const ALLOW_PRODUCTION =\) .*/\1 TRUE;/' \
	%buildroot%prefix/op5/ninja/application/controllers/authenticated.php
find %buildroot -print0 | xargs -0 chmod a+r
find %buildroot -type d -print0 | xargs -0 chmod a+x

mkdir -p %buildroot/etc/cron.d/
install -m 644 install_scripts/scheduled_reports.crontab %buildroot/etc/cron.d/scheduled-reports

# executables
for f in cli-helpers/apr_md5_validate cli-helpers/htpasswd-import.php \
		install_scripts/ninja_db_init.sh; do
	chmod 755 %buildroot%prefix/op5/ninja/$f
done


%post
ln -sfT /opt/monitor/op5/ninja /var/www/html/ninja
sh /opt/monitor/op5/ninja/install_scripts/ninja_db_init.sh

sh %prefix/op5/ninja/op5-upgradescripts/monitor-reports-db-upgrade.sh %prefix

%files
%defattr(-,monitor,apache)
/opt/monitor/op5/ninja
/etc/cron.d/scheduled-reports

%clean
rm -rf %buildroot
