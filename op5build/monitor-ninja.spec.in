Name: monitor-ninja
Version: @@VERSION@@
Release: @@RELEASE@@
License: op5 Software License
Packager: build@op5
Vendor: op5 AB
BuildRoot: /tmp/%name-%version
Summary: op5 monitor ninja
Group: op5/Monitor
Prefix: /opt/monitor/op5/ninja
Requires: monitor-gui-core
Requires: merlin, monitor-reports-module >= 2.0.6
Requires: op5auth >= 1.2.0
Conflicts: monitor-gui-core <= 4.0.7
Source: %name-%version.tar.gz
%description
Webgui for Nagios 3.

%prep
%setup -q

%build
pushd cli-helpers
make
popd
make test docs


%install
rm -rf %buildroot
mkdir -p -m 755 %buildroot%prefix
cp -r * %buildroot%prefix
sed -i 's/\([\t ]const ALLOW_PRODUCTION =\) .*/\1 TRUE;/' \
	%buildroot%prefix/application/controllers/authenticated.php
sed -i \
	-e 's,^\(.config..site_domain.. = .\)/ninja/,\1/monitor/,' \
	-e 's/^\(.config..product_name.. = .\)Nagios/\1op5 Monitor/' \
	-e 's/^\(.config..version_info.. = .\)\/etc\/ninja-release/\1\/etc\/op5-monitor-release/' \
	%buildroot%prefix/application/config/config.php

cp op5build/login.png \
	%buildroot%prefix/application/views/themes/default/css/default/images
cp op5build/favicon.ico \
	%buildroot%prefix/application/views/themes/default/icons/16x16/
cp op5build/icon.png \
	%buildroot%prefix/application/views/themes/default/icons/

find %buildroot -print0 | xargs -0 chmod a+r
find %buildroot -type d -print0 | xargs -0 chmod a+x

mkdir -p %buildroot/etc/cron.d/
install -m 644 install_scripts/scheduled_reports.crontab %buildroot/etc/cron.d/scheduled-reports
install -m 644 install_scripts/recurring_downtime.crontab %buildroot/etc/cron.d/recurring-downtime

# executables
for f in cli-helpers/apr_md5_validate cli-helpers/htpasswd-import.php \
		install_scripts/ninja_db_init.sh; do
	chmod 755 %buildroot%prefix/$f
done

mkdir -p %buildroot/var/www/html
ln -sfT %prefix %buildroot/var/www/html/monitor
# recursive symbolic link, so must be after all 'find' stuff above
ln -s ../ %buildroot%prefix/op5

%post
sh %prefix/install_scripts/ninja_db_init.sh

sh %prefix/op5-upgradescripts/monitor-reports-db-upgrade.sh /opt/monitor

# Set driver to LDAP if ad or ldap is configured
if [ -f /opt/op5sys/etc/ldapserver ]; then
  sed -i "s/^\$config\[\"*'*driver\"*'*\].*/\$config\['driver'\] = 'LDAP';/" %prefix/application/config/auth.php
fi

%files
%defattr(-,monitor,apache)
%prefix
/etc/cron.d/scheduled-reports
/var/www/html/monitor

%clean
rm -rf %buildroot
